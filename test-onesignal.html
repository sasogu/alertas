<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- OneSignal Configuration -->
    <meta name="onesignal-app-id" content="75f7bf03-ba86-4059-99cc-797fe53a147d" />
    <meta name="onesignal-safari-id" content="web.onesignal.auto.3f550615-46c0-4fa5-9ee8-42953ece3d19" />
    
    <title>Prueba OneSignal - Camino Medio</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        
        .test-container {
            background: rgba(255, 255, 255, 0.98); /* M√°s opaco para mejor contraste */
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            margin: 2rem auto;
            max-width: 800px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .status-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin: 1rem 0;
            padding: 1.5rem;
            border-left: 5px solid #dee2e6;
            transition: all 0.3s ease;
            color: #333; /* Texto m√°s oscuro para mejor contraste */
        }
        
        .status-card h5 {
            color: #2c3e50 !important; /* T√≠tulos m√°s oscuros */
            font-weight: 600;
        }
        
        .status-card p {
            color: #495057 !important; /* Texto del contenido m√°s legible */
        }
        
        .status-card.success {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724; /* Texto verde oscuro para mejor contraste */
        }
        
        .status-card.error {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24; /* Texto rojo oscuro para mejor contraste */
        }
        
        .status-card.warning {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404; /* Texto amarillo oscuro para mejor contraste */
        }
        
        .test-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            color: white !important; /* Forzar texto blanco */
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
            text-decoration: none;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            color: white !important; /* Mantener texto blanco en hover */
        }
        
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            color: white !important;
        }
        
        .console-output {
            background: #1a1a1a;
            color: #00ff41; /* Verde m√°s brillante para mejor legibilidad */
            border-radius: 10px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
            border: 1px solid #333;
        }
        
        .zen-icon {
            font-size: 3rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Mejorar botones de Bootstrap */
        .btn-outline-info {
            color: #0dcaf0 !important;
            border-color: #0dcaf0 !important;
        }
        
        .btn-outline-info:hover {
            background-color: #0dcaf0 !important;
            border-color: #0dcaf0 !important;
            color: white !important;
        }
        
        /* T√≠tulos principales */
        h1, h2, h3, h4, h5, h6 {
            color: #2c3e50 !important;
        }
        
        .text-muted {
            color: #6c757d !important;
        }
        
        /* Informaci√≥n del usuario */
        .user-info {
            background: rgba(13, 110, 253, 0.1);
            border: 1px solid rgba(13, 110, 253, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .user-info h5 {
            color: #0d6efd !important;
        }
        
        .user-info p {
            color: #495057 !important;
        }
        
        /* Instrucciones */
        .instructions {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem 0;
        }
        
        .instructions h4 {
            color: #b8860b !important;
        }
        
        .instructions p, .instructions ul, .instructions li {
            color: #495057 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="test-container p-4">
            <!-- Header -->
            <div class="text-center mb-4">
                <i class="fas fa-bell zen-icon"></i>
                <h1 class="mt-3 mb-2">Prueba OneSignal</h1>
                <p class="text-muted">Verificaci√≥n del sistema de notificaciones push</p>
            </div>

            <!-- Estado de la configuraci√≥n -->
            <div id="config-status" class="status-card">
                <h5><i class="fas fa-cog me-2"></i>Estado de Configuraci√≥n</h5>
                <div id="config-details">
                    <p class="mb-1"><i class="fas fa-spinner fa-spin me-2"></i>Verificando configuraci√≥n...</p>
                </div>
            </div>

            <!-- Estado de OneSignal -->
            <div id="onesignal-status" class="status-card">
                <h5><i class="fas fa-satellite-dish me-2"></i>Estado de OneSignal</h5>
                <div id="onesignal-details">
                    <p class="mb-1"><i class="fas fa-spinner fa-spin me-2"></i>Inicializando OneSignal...</p>
                </div>
            </div>

            <!-- Estado de permisos -->
            <div id="permission-status" class="status-card">
                <h5><i class="fas fa-shield-alt me-2"></i>Estado de Permisos</h5>
                <div id="permission-details">
                    <p class="mb-1"><i class="fas fa-spinner fa-spin me-2"></i>Verificando permisos...</p>
                </div>
            </div>

            <!-- Botones de prueba -->
            <div class="text-center my-4">
                <button id="btn-request-permission" class="test-button me-2 mb-2">
                    <i class="fas fa-bell me-2"></i>Solicitar Permisos
                </button>
                <button id="btn-test-notification" class="test-button me-2 mb-2">
                    <i class="fas fa-paper-plane me-2"></i>Enviar Notificaci√≥n OneSignal
                </button>
                <button id="btn-test-local" class="test-button me-2 mb-2">
                    <i class="fas fa-volume-up me-2"></i>Probar Notificaci√≥n Local
                </button>
                <button id="btn-debug-config" class="btn btn-outline-info me-2 mb-2">
                    <i class="fas fa-bug me-2"></i>Debug Configuraci√≥n
                </button>
                <button id="btn-debug-sw" class="btn btn-outline-warning me-2 mb-2">
                    <i class="fas fa-cogs me-2"></i>Debug Service Workers
                </button>
            </div>

            <!-- Informaci√≥n del usuario -->
            <div id="user-info" class="status-card">
                <h5><i class="fas fa-user me-2"></i>Informaci√≥n del Usuario</h5>
                <div id="user-details">
                    <p class="mb-1">Player ID: <span id="player-id">No disponible</span></p>
                    <p class="mb-1">Estado de suscripci√≥n: <span id="subscription-status">No disponible</span></p>
                    <p class="mb-0">Token: <span id="push-token">No disponible</span></p>
                </div>
            </div>

            <!-- Consola de debugging -->
            <div class="mt-4">
                <h5><i class="fas fa-terminal me-2"></i>Consola de Debugging</h5>
                <div id="console" class="console-output">
                    <div class="text-info">[INIT] Iniciando pruebas de OneSignal...</div>
                </div>
                <button id="btn-clear-console" class="btn btn-outline-secondary btn-sm mt-2">
                    <i class="fas fa-trash me-1"></i>Limpiar Consola
                </button>
            </div>

            <!-- Instrucciones -->
            <div class="mt-4">
                <h5><i class="fas fa-question-circle me-2"></i>Instrucciones de Uso</h5>
                <div class="row">
                    <div class="col-md-6">
                        <h6>üîß Desarrollo Local:</h6>
                        <ol>
                            <li>La p√°gina funciona con credenciales en <code>env-config.js</code></li>
                            <li>Haz clic en "Solicitar Permisos" para habilitar notificaciones</li>
                            <li>Usa "Probar Notificaci√≥n Local" primero</li>
                            <li>HTTPS requerido para OneSignal (producci√≥n)</li>
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <h6>üöÄ Producci√≥n:</h6>
                        <ol>
                            <li>Ejecuta: <code>cd alertas && node config-server.js</code></li>
                            <li>Sube service worker a la ra√≠z del dominio</li>
                            <li>Verifica HTTPS habilitado</li>
                            <li>Prueba notificaciones push</li>
                        </ol>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Tip:</strong> En desarrollo local, las notificaciones OneSignal pueden no funcionar completamente. 
                    Usa "Probar Notificaci√≥n Local" para verificar que los permisos funcionan.
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- OneSignal SDK con fallback local -->
    <script>
        // Funci√≥n para cargar OneSignal con fallback
        function loadOneSignalSDK() {
            return new Promise((resolve, reject) => {
                // Intentar cargar desde CDN primero
                const cdnScript = document.createElement('script');
                cdnScript.src = 'https://cdn.onesignal.com/sdks/OneSignalSDK.js';
                cdnScript.defer = true;
                
                cdnScript.onload = () => {
                    console.log('‚úÖ OneSignal SDK cargado desde CDN');
                    resolve();
                };
                
                cdnScript.onerror = () => {
                    console.warn('‚ö†Ô∏è Fallo CDN, intentando SDK local...');
                    // Fallback: cargar desde archivo local
                    const localScript = document.createElement('script');
                    localScript.src = 'js/OneSignalSDK.js';
                    
                    localScript.onload = () => {
                        console.log('‚úÖ OneSignal SDK cargado localmente');
                        resolve();
                    };
                    
                    localScript.onerror = () => {
                        console.error('‚ùå Error cargando OneSignal SDK');
                        reject(new Error('No se pudo cargar OneSignal SDK'));
                    };
                    
                    document.head.appendChild(localScript);
                };
                
                document.head.appendChild(cdnScript);
            });
        }
        
        // Cargar SDK al inicio
        loadOneSignalSDK().catch(console.error);
    </script>
    
    <!-- Configuraci√≥n simple para pruebas -->
    <script src="js/simple-config.js"></script>
    
    <!-- Configuraci√≥n de entorno -->
    <script src="js/env-config.js"></script>
    
    <!-- OneSignal Configuration -->
    <script src="js/onesignal-config.js"></script>

    <script>
        class OneSignalTester {
            constructor() {
                this.console = document.getElementById('console');
                this.configStatus = document.getElementById('config-status');
                this.onesignalStatus = document.getElementById('onesignal-status');
                this.permissionStatus = document.getElementById('permission-status');
                
                this.btnRequestPermission = document.getElementById('btn-request-permission');
                this.btnTestNotification = document.getElementById('btn-test-notification');
                this.btnTestLocal = document.getElementById('btn-test-local');
                this.btnClearConsole = document.getElementById('btn-clear-console');
                
                this.setupEventListeners();
                this.init();
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const colors = {
                    info: '#00ff00',
                    warn: '#ffff00', 
                    error: '#ff0000',
                    success: '#00ff88'
                };
                
                this.console.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
                this.console.scrollTop = this.console.scrollHeight;
            }

            updateStatus(element, status, message, icon = '') {
                element.className = `status-card ${status}`;
                const details = element.querySelector('div[id$="-details"]');
                details.innerHTML = `<p class="mb-1"><i class="fas ${icon} me-2"></i>${message}</p>`;
            }

            setupEventListeners() {
                this.btnRequestPermission.addEventListener('click', () => this.requestPermission());
                this.btnTestNotification.addEventListener('click', () => this.testNotification());
                this.btnTestLocal.addEventListener('click', () => this.testLocalNotification());
                this.btnClearConsole.addEventListener('click', () => this.clearConsole());
                
                // Botones de debug
                const btnDebugConfig = document.getElementById('btn-debug-config');
                const btnDebugSW = document.getElementById('btn-debug-sw');
                
                if (btnDebugConfig) {
                    btnDebugConfig.addEventListener('click', () => this.debugConfiguration());
                }
                if (btnDebugSW) {
                    btnDebugSW.addEventListener('click', () => this.debugServiceWorkers());
                }
            }

            async init() {
                this.log('Iniciando verificaci√≥n de configuraci√≥n...');
                
                // Verificar configuraci√≥n
                await this.checkConfiguration();
                
                // Verificar OneSignal
                await this.checkOneSignal();
                
                // Verificar permisos
                await this.checkPermissions();
                
                this.log('Verificaci√≥n inicial completada', 'success');
            }

            async checkConfiguration() {
                try {
                    this.log('üîç Verificando configuraci√≥n...');
                    
                    // Esperar a que envConfig est√© disponible y listo
                    let attempts = 0;
                    while (!window.envConfig && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    if (!window.envConfig) {
                        throw new Error('Configuraci√≥n de entorno no disponible');
                    }

                    // Esperar a que la configuraci√≥n est√© completamente cargada
                    this.log('‚è≥ Esperando configuraci√≥n completa...', 'info');
                    await window.envConfig.waitForReady();
                    
                    this.log('‚úÖ Configuraci√≥n lista, verificando validez...', 'info');

                    // Verificar si hay configuraci√≥n del servidor
                    try {
                        const response = await fetch('/api/config');
                        if (response.ok) {
                            const config = await response.json();
                            this.updateStatus(this.configStatus, 'success', 
                                `‚úÖ Servidor configurado - App ID: ${config.ONESIGNAL_APP_ID.substring(0, 8)}...`, 
                                'fa-check-circle');
                            this.log(`‚úÖ Configuraci√≥n desde servidor: ${config.ONESIGNAL_APP_ID}`, 'success');
                        } else {
                            throw new Error('Servidor de configuraci√≥n no disponible');
                        }
                    } catch (serverError) {
                        // Fallback a configuraci√≥n local
                        if (window.envConfig.isConfigured()) {
                            const appId = window.envConfig.get('ONESIGNAL_APP_ID');
                            this.updateStatus(this.configStatus, 'warning', 
                                `‚ö° Modo desarrollo - App ID: ${appId.substring(0, 8)}... (Local)`, 
                                'fa-exclamation-triangle');
                            this.log(`‚ö° Configuraci√≥n local cargada: ${appId}`, 'warn');
                            this.log('üí° Para producci√≥n, inicia: cd alertas && node config-server.js', 'info');
                        } else {
                            this.updateStatus(this.configStatus, 'error', 
                                '‚ùå Configuraci√≥n no v√°lida - Verifica credenciales', 
                                'fa-times-circle');
                            this.log('‚ùå Configuraci√≥n no v√°lida - revisa env-config.js', 'error');
                        }
                    }

                } catch (error) {
                    this.updateStatus(this.configStatus, 'error', 
                        `‚ùå Error: ${error.message}`, 'fa-times-circle');
                    this.log(`‚ùå Error de configuraci√≥n: ${error.message}`, 'error');
                }
            }

            async checkOneSignal() {
                try {
                    this.log('üîå Verificando OneSignal SDK...', 'info');
                    
                    // Verificar si el script se carg√≥
                    const scripts = document.querySelectorAll('script[src*="OneSignalSDK"]');
                    this.log(`üìú Scripts de OneSignal encontrados: ${scripts.length}`, 'info');
                    
                    if (scripts.length > 0) {
                        for (let script of scripts) {
                            this.log(`üìã Script: ${script.src} - loaded: ${script.readyState || 'unknown'}`, 'info');
                        }
                    }
                    
                    // Esperar a que OneSignal est√© disponible
                    let attempts = 0;
                    while (!window.OneSignal && attempts < 100) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    if (!window.OneSignal) {
                        this.log('‚ùå window.OneSignal no est√° disponible despu√©s de 10 segundos', 'error');
                        this.log('üîç Verificando errores de red...', 'info');
                        
                        // Intentar cargar OneSignal manualmente para diagn√≥stico
                        try {
                            const response = await fetch('https://cdn.onesignal.com/sdks/OneSignalSDK.js');
                            this.log(`üåê CDN Response Status: ${response.status}`, 'info');
                            if (!response.ok) {
                                throw new Error(`CDN returned ${response.status}`);
                            }
                        } catch (fetchError) {
                            this.log(`üö´ Error accessing CDN: ${fetchError.message}`, 'error');
                        }
                        
                        throw new Error('OneSignal SDK no cargado - verifica conexi√≥n a internet');
                    }

                    this.log('üì° OneSignal SDK cargado, esperando inicializaci√≥n...', 'info');

                    // Esperar a que OneSignalManager est√© inicializado
                    attempts = 0;
                    while (!window.oneSignalManager && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    if (window.oneSignalManager && window.oneSignalManager.isInitialized) {
                        this.updateStatus(this.onesignalStatus, 'success', 
                            '‚úÖ OneSignal inicializado y listo', 'fa-check-circle');
                        this.log('‚úÖ OneSignal completamente inicializado', 'success');
                        return true;
                    } else if (window.oneSignalManager) {
                        this.updateStatus(this.onesignalStatus, 'warning', 
                            '‚è≥ OneSignal cargado pero esperando inicializaci√≥n...', 'fa-exclamation-triangle');
                        this.log('‚è≥ OneSignal a√∫n inicializando', 'warn');
                        
                        // Log informaci√≥n de debug sobre el estado
                        if (window.oneSignalManager.config) {
                            this.log(`üîß Config App ID: ${window.oneSignalManager.config.appId}`, 'info');
                        } else {
                            this.log('‚ö†Ô∏è OneSignalManager sin configuraci√≥n - verificando config...', 'warn');
                        }
                        
                        // Solo reintentar unas pocas veces m√°s
                        if (!this.onesignalRetries) this.onesignalRetries = 0;
                        this.onesignalRetries++;
                        
                        if (this.onesignalRetries < 5) {
                            setTimeout(() => this.checkOneSignal(), 3000);
                        } else {
                            this.log('‚ö†Ô∏è M√°ximo de reintentos alcanzado - OneSignal puede requerir HTTPS en producci√≥n', 'warn');
                        }
                        
                        return false;
                    } else {
                        this.updateStatus(this.onesignalStatus, 'error', 
                            '‚ùå OneSignalManager no disponible', 'fa-times-circle');
                        this.log('‚ùå OneSignalManager no creado', 'error');
                        return false;
                    }

                } catch (error) {
                    this.updateStatus(this.onesignalStatus, 'error', 
                        `‚ùå Error: ${error.message}`, 'fa-times-circle');
                    this.log(`‚ùå Error de OneSignal: ${error.message}`, 'error');
                    return false;
                }
            }

            async checkPermissions() {
                try {
                    const permission = Notification.permission;
                    let status, message, icon;

                    switch (permission) {
                        case 'granted':
                            status = 'success';
                            message = 'Permisos de notificaci√≥n concedidos';
                            icon = 'fa-check-circle';
                            break;
                        case 'denied':
                            status = 'error';
                            message = 'Permisos denegados - Habil√≠talos en configuraci√≥n del navegador';
                            icon = 'fa-times-circle';
                            this.log('üö´ Permisos denegados. Para habilitar:', 'error');
                            this.log('  Chrome: ‚öôÔ∏è ‚Üí Privacidad ‚Üí Configuraci√≥n del sitio ‚Üí Notificaciones', 'info');
                            this.log('  Firefox: üîí (candado) ‚Üí Permisos ‚Üí Notificaciones ‚Üí Permitir', 'info');
                            this.log('  Safari: Safari ‚Üí Preferencias ‚Üí Sitios web ‚Üí Notificaciones', 'info');
                            break;
                        default:
                            status = 'warning';
                            message = 'Permisos de notificaci√≥n no solicitados';
                            icon = 'fa-exclamation-triangle';
                    }

                    this.updateStatus(this.permissionStatus, status, message, icon);
                    this.log(`Estado de permisos: ${permission}`, permission === 'granted' ? 'success' : 'warn');

                    // Actualizar informaci√≥n del usuario
                    await this.updateUserInfo();

                } catch (error) {
                    this.updateStatus(this.permissionStatus, 'error', 
                        `Error: ${error.message}`, 'fa-times-circle');
                    this.log(`Error verificando permisos: ${error.message}`, 'error');
                }
            }

            async updateUserInfo() {
                try {
                    if (window.OneSignal && window.oneSignalManager) {
                        const playerId = await OneSignal.getUserId();
                        const isSubscribed = await OneSignal.getNotificationPermission() === 'granted';
                        const pushToken = await OneSignal.getRegistrationId();

                        document.getElementById('player-id').textContent = playerId || 'No disponible';
                        document.getElementById('subscription-status').textContent = isSubscribed ? 'Suscrito' : 'No suscrito';
                        document.getElementById('push-token').textContent = pushToken ? pushToken.substring(0, 20) + '...' : 'No disponible';
                    }
                } catch (error) {
                    this.log(`Error obteniendo informaci√≥n del usuario: ${error.message}`, 'error');
                }
            }

            async requestPermission() {
                try {
                    this.log('üîî Solicitando permisos de notificaci√≥n...');
                    
                    // Intentar con OneSignal primero si est√° disponible
                    if (window.oneSignalManager && window.oneSignalManager.isInitialized) {
                        this.log('üì± Usando OneSignal para solicitar permisos...', 'info');
                        const result = await window.oneSignalManager.requestPermission();
                        if (result) {
                            this.log('‚úÖ Permisos concedidos via OneSignal', 'success');
                            await this.checkPermissions();
                            return;
                        } else {
                            this.log('‚ùå Permisos denegados via OneSignal', 'error');
                        }
                    } else {
                        this.log('‚ö†Ô∏è OneSignal no disponible, usando API nativa...', 'warn');
                    }
                    
                    // Fallback a API nativa de navegador
                    if ('Notification' in window) {
                        const permission = await Notification.requestPermission();
                        this.log(`üìã Resultado API nativa: ${permission}`, permission === 'granted' ? 'success' : 'error');
                        await this.checkPermissions();
                        
                        if (permission === 'granted') {
                            this.log('‚úÖ ¬°Permisos concedidos! Ya puedes recibir notificaciones', 'success');
                        } else if (permission === 'denied') {
                            this.log('‚ùå Permisos denegados. Puedes habilitarlos en configuraci√≥n del navegador', 'error');
                        } else {
                            this.log('‚è∏Ô∏è Solicitud de permisos cancelada', 'warn');
                        }
                    } else {
                        this.log('‚ùå Tu navegador no soporta notificaciones', 'error');
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Error solicitando permisos: ${error.message}`, 'error');
                }
            }

            async testNotification() {
                try {
                    this.log('Enviando notificaci√≥n de prueba...');
                    
                    if (window.oneSignalManager) {
                        await window.oneSignalManager.sendMindfulnessAlert('üß™ Notificaci√≥n de prueba desde OneSignal');
                        this.log('Notificaci√≥n enviada via OneSignal', 'success');
                    } else {
                        this.log('OneSignalManager no disponible', 'error');
                    }
                } catch (error) {
                    this.log(`Error enviando notificaci√≥n: ${error.message}`, 'error');
                }
            }

            testLocalNotification() {
                try {
                    this.log('Enviando notificaci√≥n local...');
                    
                    if (Notification.permission === 'granted') {
                        const notification = new Notification('Camino Medio - Prueba', {
                            body: 'üß™ Esta es una notificaci√≥n de prueba local',
                            icon: '../assets/img/logocompleto.png',
                            badge: '../assets/img/logopeque.png',
                            tag: 'test-notification'
                        });

                        notification.onclick = () => {
                            this.log('Notificaci√≥n clickeada', 'info');
                            notification.close();
                        };

                        setTimeout(() => notification.close(), 5000);
                        this.log('Notificaci√≥n local enviada', 'success');
                    } else {
                        this.log('Permisos no concedidos para notificaciones locales', 'error');
                    }
                } catch (error) {
                    this.log(`Error con notificaci√≥n local: ${error.message}`, 'error');
                }
            }

            clearConsole() {
                this.console.innerHTML = '<div class="text-info">[INIT] Consola limpiada...</div>';
            }

            async debugConfiguration() {
                this.log('üîç === DEBUG CONFIGURACI√ìN ===', 'info');
                
                // Verificar configuraci√≥n simple
                this.log(`window.ONESIGNAL_CONFIG existe: ${!!window.ONESIGNAL_CONFIG}`, 'info');
                if (window.ONESIGNAL_CONFIG) {
                    this.log(`Simple Config App ID: ${window.ONESIGNAL_CONFIG.APP_ID}`, 'info');
                }
                
                // Verificar envConfig
                this.log(`window.envConfig existe: ${!!window.envConfig}`, 'info');
                
                if (window.envConfig) {
                    this.log(`envConfig.isReady: ${window.envConfig.isReady}`, 'info');
                    this.log(`envConfig.isConfigured(): ${window.envConfig.isConfigured()}`, 'info');
                    this.log(`App ID: ${window.envConfig.get('ONESIGNAL_APP_ID')}`, 'info');
                    this.log(`Safari Web ID: ${window.envConfig.get('ONESIGNAL_SAFARI_WEB_ID')}`, 'info');
                    this.log(`Config object:`, 'info');
                    this.log(JSON.stringify(window.envConfig.config, null, 2), 'info');
                }
                
                // Verificar OneSignal
                this.log(`window.OneSignal existe: ${!!window.OneSignal}`, 'info');
                this.log(`window.OneSignalManager existe: ${!!window.OneSignalManager}`, 'info');
                this.log(`window.oneSignalManager existe: ${!!window.oneSignalManager}`, 'info');
                
                if (window.oneSignalManager) {
                    this.log(`oneSignalManager.isInitialized: ${window.oneSignalManager.isInitialized}`, 'info');
                    this.log(`oneSignalManager.config appId: ${window.oneSignalManager.config?.appId || 'undefined'}`, 'info');
                    this.log(`oneSignalManager.isSubscribed: ${window.oneSignalManager.isSubscribed}`, 'info');
                    this.log(`oneSignalManager.playerId: ${window.oneSignalManager.playerId || 'null'}`, 'info');
                }
                
                // Verificar funci√≥n de configuraci√≥n
                if (window.getOneSignalConfig) {
                    this.log('üîß Probando getOneSignalConfig()...', 'info');
                    try {
                        const config = window.getOneSignalConfig();
                        this.log(`getOneSignalConfig() retorna App ID: ${config.appId}`, 'info');
                    } catch (error) {
                        this.log(`Error en getOneSignalConfig(): ${error.message}`, 'error');
                    }
                }
                
                this.log(`Notification.permission: ${Notification.permission}`, 'info');
                this.log(`window.location.protocol: ${window.location.protocol}`, 'info');
                this.log(`window.location.hostname: ${window.location.hostname}`, 'info');
                
                // Intentar reinicializar configuraci√≥n
                if (window.envConfig && !window.envConfig.isReady) {
                    this.log('üîÑ Configuraci√≥n no lista, intentando reinicializar...', 'warn');
                    await window.envConfig.init();
                    this.log(`üîÑ Despu√©s de reinicializar - isReady: ${window.envConfig.isReady}`, 'info');
                }
                
                this.log('üîç === FIN DEBUG ===', 'info');
            }

            async debugServiceWorkers() {
                this.log('üîß === DEBUG SERVICE WORKERS ===', 'info');
                
                // Verificar service workers disponibles
                if ('serviceWorker' in navigator) {
                    this.log('‚úÖ Service Worker API disponible', 'info');
                    
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        this.log(`üìã Registros de SW encontrados: ${registrations.length}`, 'info');
                        
                        for (let i = 0; i < registrations.length; i++) {
                            const reg = registrations[i];
                            this.log(`SW ${i + 1}: ${reg.scope}`, 'info');
                            this.log(`  - Active: ${reg.active ? reg.active.scriptURL : 'none'}`, 'info');
                            this.log(`  - Installing: ${reg.installing ? reg.installing.scriptURL : 'none'}`, 'info');
                            this.log(`  - Waiting: ${reg.waiting ? reg.waiting.scriptURL : 'none'}`, 'info');
                        }
                    } catch (error) {
                        this.log(`‚ùå Error obteniendo SW: ${error.message}`, 'error');
                    }
                } else {
                    this.log('‚ùå Service Worker API no disponible', 'error');
                }
                
                // Verificar rutas de service workers
                const swPaths = [
                    '/app/OneSignalSDKWorker.js',
                    '/app/OneSignalSDKUpdaterWorker.js'
                ];
                
                for (const path of swPaths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            const content = await response.text();
                            this.log(`‚úÖ ${path} accesible (${content.length} chars)`, 'success');
                            this.log(`üìù Contenido: ${content.substring(0, 80)}...`, 'info');
                        } else {
                            this.log(`‚ùå ${path} no accesible (${response.status})`, 'error');
                        }
                    } catch (error) {
                        this.log(`‚ùå Error verificando ${path}: ${error.message}`, 'error');
                    }
                }
                
                this.log('üîß === FIN DEBUG SERVICE WORKERS ===', 'info');
            }
        }

        // Inicializar cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ P√°gina cargada, inicializando OneSignal...');
            
            // Crear instancia global de OneSignalManager si no existe
            const initOneSignal = () => {
                if (window.OneSignalManager && window.envConfig && window.envConfig.isConfigured()) {
                    console.log('‚úÖ Inicializando OneSignalManager...');
                    window.oneSignalManager = new OneSignalManager();
                } else {
                    console.log('‚è≥ Esperando OneSignal y configuraci√≥n...');
                    setTimeout(initOneSignal, 500);
                }
            };
            
            // Iniciar despu√©s de un peque√±o delay para asegurar que todo est√© cargado
            setTimeout(initOneSignal, 1000);
            
            // Inicializar el tester inmediatamente
            window.tester = new OneSignalTester();
        });
    </script>
</body>
</html>
