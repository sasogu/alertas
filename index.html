<!DOCTYPE html>
<html lang="es">

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="Shoken - Recordatorios sonoros para pr√°ctica consciente" />

        <!-- OneSignal Configuration -->
        <meta name="onesignal-app-id" content="75f7bf03-ba86-4059-99cc-797fe53a147d" />
        <meta name="onesignal-safari-id" content="web.onesignal.auto.3f550615-46c0-4fa5-9ee8-42953ece3d19" />

        <!-- PWA Meta Tags -->
        <meta name="theme-color" content="#2d5a4f">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="Alertas">
        <meta name="msapplication-TileColor" content="#2d5a4f">
        <meta name="msapplication-TileImage" content="/assets/icons/192x192.png">

        <title>Shoken - Camino Medio</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <link rel="apple-touch-icon" href="assets/icons/192x192.png" />
        <link rel="apple-touch-icon" sizes="192x192" href="assets/icons/192x192.png" />
        <link rel="apple-touch-icon" sizes="512x512" href="assets/icons/512x512.png" />

        <!-- OneSignal Push Notifications (Versi√≥n Oficial Funcional) -->
        <!-- NO cargar script aqu√≠ - lo maneja onesignal-working.js -->

        <!-- Font Awesome icons -->
        <script defer src="https://use.fontawesome.com/releases/v6.5.2/js/all.js"></script>

        <!-- Google fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" />

        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="css/alertas.css" rel="stylesheet" />
        <link rel="manifest" href="/manifest.json">
    </head>

    <body class="bg-dark text-white">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-black fixed-top">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="index.html">
                    <img src="assets/icons/logoblanco.png" alt="Camino Medio" height="40" class="me-3">
                    <span class="text-white">Camino Medio</span>
                </a>
                <h4 class="text-white mb-0 ms-auto">Atenci√≥n Plena</h4>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mt-5 pt-5">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <!-- Status Card -->
                    <div class="card bg-dark border-light mb-4">
                        <div class="card-body text-center">
                            <div id="status-indicator" class="status-inactive mb-3">
                                <i class="fas fa-bell-slash fa-3x"></i>
                            </div>
                            <h3 id="status-text">Alertas Desactivadas</h3>
                            <p id="next-alert" class="text-muted"></p>
                            <button id="toggle-btn" class="btn btn-primary btn-lg">
                                <i class="fas fa-play me-2"></i>Activar Alertas
                            </button>
                        </div>
                    </div>

                    <!-- Configuration Card -->
                    <div class="card bg-dark border-light mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Configuraci√≥n</h5>
                        </div>
                        <div class="card-body">
                            <!-- Interval Settings -->
                            <div class="mb-4">
                                <label class="form-label">Intervalo de tiempo</label>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="interval-minutes" class="form-label small">Minutos</label>
                                        <input type="number" class="form-control" id="interval-minutes" min="0" max="59"
                                            value="5">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="interval-seconds" class="form-label small">Segundos</label>
                                        <input type="number" class="form-control" id="interval-seconds" min="0" max="59"
                                            value="0">
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex flex-column h-100">
                                            <label class="form-label small">Presets</label>
                                            <select class="form-select" id="preset-intervals">
                                                <option value="">Personalizado</option>
                                                <option value="30">30 segundos</option>
                                                <option value="60">1 minuto</option>
                                                <option value="300">5 minutos</option>
                                                <option value="600">10 minutos</option>
                                                <option value="900">15 minutos</option>
                                                <option value="1800">30 minutos</option>
                                                <option value="3600">1 hora</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sound Settings -->
                            <div class="mb-4">
                                <label class="form-label">Sonido de alerta</label>
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <select class="form-select" id="sound-select">
                                            <option value="bell1">Cuenco Zen</option>
                                            <option value="bell2">Gong Suave</option>
                                            <option value="bell3">Cuenco Tibetano</option>
                                            <option value="bell4">Carill√≥n</option>
                                            <option value="bell5">Om Mantra</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-outline-light w-100" id="test-sound">
                                            <i class="fas fa-volume-up me-2"></i>Probar
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>En m√≥viles:</strong> El sonido puede no reproducirse si la pantalla est√° apagada. 
                                        Activa tambi√©n las notificaciones push y vibraci√≥n para mayor fiabilidad.
                                    </small>
                                </div>
                            </div>

                            <!-- Volume Control -->
                            <div class="mb-4">
                                <label for="volume-control" class="form-label">Volumen</label>
                                <input type="range" class="form-range" id="volume-control" min="0" max="100" value="70">
                                <div class="d-flex justify-content-between small text-muted">
                                    <span>0%</span>
                                    <span id="volume-display">70%</span>
                                    <span>100%</span>
                                </div>
                            </div>

                            <!-- Vibration Settings -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="vibration-enabled">
                                    <label class="form-check-label" for="vibration-enabled">
                                        <i class="fas fa-mobile-alt me-2"></i>Activar vibraci√≥n (m√≥viles)
                                    </label>
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-light btn-sm" id="test-vibration">
                                        <i class="fas fa-mobile-alt me-1"></i>Probar Vibraci√≥n
                                    </button>
                                    <small class="text-muted ms-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Solo funciona en m√≥viles Android
                                    </small>
                                </div>
                            </div>

                            <!-- Push Notifications Settings -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="push-notifications-enabled">
                                    <label class="form-check-label" for="push-notifications-enabled">
                                        <i class="fas fa-bell me-2"></i>Notificaciones Push (funciona con tel√©fono
                                        inactivo)
                                    </label>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Las notificaciones push permiten recibir alertas aunque la app est√© cerrada
                                    </small>
                                </div>
                                <div id="push-status" class="mt-2" style="display: none;">
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Notificaciones habilitadas
                                    </span>
                                </div>
                                
                                <!-- Push Backup Interval Settings -->
                                <div class="mt-3">
                                    <label for="push-backup-interval" class="form-label small">
                                        <i class="fas fa-clock me-1"></i>Verificar inactividad cada:
                                    </label>
                                    <div class="row g-2">
                                        <div class="col-md-8">
                                            <select class="form-select form-select-sm" id="push-backup-interval">
                                                <option value="2">2 minutos</option>
                                                <option value="5">5 minutos</option>
                                                <option value="10" selected>10 minutos</option>
                                                <option value="15">15 minutos</option>
                                                <option value="30">30 minutos</option>
                                                <option value="60">1 hora</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <button type="button" class="btn btn-outline-info btn-sm w-100" id="test-push-backup">
                                                <i class="fas fa-paper-plane me-1"></i>Probar
                                            </button>
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Tiempo para verificar si enviar notificaci√≥n push cuando la app est√© inactiva
                                    </small>
                                </div>
                            </div>

                            <!-- Auto-stop Settings -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto-stop-enabled">
                                    <label class="form-check-label" for="auto-stop-enabled">
                                        Parar autom√°ticamente despu√©s de:
                                    </label>
                                </div>
                                <div class="mt-2">
                                    <select class="form-select" id="auto-stop-duration" disabled>
                                        <option value="10">10 alertas</option>
                                        <option value="20">20 alertas</option>
                                        <option value="30">30 alertas</option>
                                        <option value="60">1 hora</option>
                                        <option value="120">2 horas</option>
                                        <option value="180">3 horas</option>
                                    </select>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="button" class="btn btn-success" id="save-config">
                                    <i class="fas fa-save me-2"></i>Guardar Configuraci√≥n
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Card -->
                    <div class="card bg-dark border-light">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Estad√≠sticas de Hoy</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="stat-item">
                                        <h3 id="alerts-count" class="text-primary">0</h3>
                                        <small class="text-muted">Alertas Recibidas</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-item">
                                        <h3 id="session-time" class="text-success">0m</h3>
                                        <small class="text-muted">Tiempo de Sesi√≥n</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-item">
                                        <h3 id="mindful-moments" class="text-warning">0</h3>
                                        <small class="text-muted">Momentos Conscientes</small>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-outline-light btn-sm" id="reset-stats">
                                    <i class="fas fa-redo me-2"></i>Reiniciar Estad√≠sticas
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Debug OneSignal Card (temporal) -->
                    <div class="card bg-dark border-warning mb-4" id="debug-card" style="display: none;">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-bug me-2"></i>Debug OneSignal</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-warning btn-sm w-100" onclick="debugOneSignal()">
                                        <i class="fas fa-info me-1"></i>Estado OneSignal
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-warning btn-sm w-100" onclick="forceInitOneSignal()">
                                        <i class="fas fa-sync me-1"></i>Forzar Init
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Presiona F12 para ver la consola del navegador
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center py-4 mt-5">
            <div class="container">
                <p class="text-muted mb-0">
                    <i class="fas fa-om me-2"></i>
                    Practica la atenci√≥n plena momento a momento
                </p>
                <a href="../index.html" class="btn btn-outline-light btn-sm mt-2">
                    <i class="fas fa-arrow-left me-2"></i>Volver al Inicio
                </a>
            </div>
        </footer>

        <!-- Audio Elements -->
        <audio id="alert-audio" preload="auto" controls style="display: none;" 
               webkit-playsinline playsinline>
            <source id="audio-source" src="sounds/bell1.mp3" type="audio/mpeg">
        </audio>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Configuraci√≥n de entorno -->
        <script src="js/env-config.js"></script>

        <!-- OneSignal Configuration (Integrado Directamente) -->
        <script>
            console.log('üì¶ Iniciando OneSignal integrado...');
            
            // OneSignal Manager integrado directamente
            class OneSignalManager {
                constructor() {
                    console.log('üèóÔ∏è Creando OneSignalManager...');
                    this.isInitialized = false;
                    this.initPromise = null;
                    this.debug = true;
                }

                log(message, level = 'info') {
                    if (this.debug) {
                        const timestamp = new Date().toISOString();
                        console.log(`[${timestamp}] [OneSignal] ${message}`);
                    }
                }

                async initialize() {
                    if (this.initPromise) {
                        return this.initPromise;
                    }

                    this.initPromise = this._doInitialize();
                    return this.initPromise;
                }

                async _doInitialize() {
                    try {
                        this.log('üöÄ Iniciando configuraci√≥n oficial OneSignal...');
                        
                        // Verificar protocolo HTTPS
                        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                            throw new Error('OneSignal requiere HTTPS');
                        }

                        // Obtener configuraci√≥n
                        const config = this.getConfig();
                        this.log('üîß Configuraci√≥n:');
                        this.log(JSON.stringify(config, null, 2));

                        // Configurar OneSignalDeferred antes de cargar el script
                        window.OneSignalDeferred = window.OneSignalDeferred || [];
                        
                        // Cargar el script oficial y esperar a que est√© disponible
                        await this.loadOfficialScript();
                        
                        // Verificar que OneSignal est√© realmente disponible
                        if (!window.OneSignal) {
                            throw new Error('OneSignal SDK no est√° disponible despu√©s de cargar el script');
                        }
                        
                        this.log('‚úÖ OneSignal SDK verificado y disponible');
                        
                        // Intentar inicializaci√≥n directa primero
                        try {
                            await window.OneSignal.init(config);
                            this.log('‚úÖ OneSignal inicializado directamente');
                            this.isInitialized = true;
                            this.setupEventHandlers(window.OneSignal);
                            this.checkInitialState(window.OneSignal);
                            return window.OneSignal;
                            
                        } catch (directError) {
                            this.log(`‚ö†Ô∏è Inicializaci√≥n directa fall√≥, intentando con deferred: ${directError.message}`);
                            
                            // Fallback a m√©todo deferred
                            return new Promise((resolve, reject) => {
                                window.OneSignalDeferred.push((OneSignal) => {
                                    this.log('üì¶ OneSignal SDK cargado via deferred');
                                    
                                    OneSignal.init(config).then(() => {
                                        this.log('‚úÖ OneSignal inicializado correctamente via deferred');
                                        this.isInitialized = true;
                                        this.setupEventHandlers(OneSignal);
                                        this.checkInitialState(OneSignal);
                                        resolve(OneSignal);
                                        
                                    }).catch(error => {
                                        this.log(`üí• Error en inicializaci√≥n deferred: ${error.message}`, 'error');
                                        reject(error);
                                    });
                                });
                                
                                // Timeout de seguridad
                                setTimeout(() => {
                                    if (!this.isInitialized) {
                                        reject(new Error('Timeout: OneSignal no se inicializ√≥ en 15 segundos'));
                                    }
                                }, 15000);
                            });
                        }

                    } catch (error) {
                        this.log(`üí• Error en configuraci√≥n: ${error.message}`, 'error');
                        throw error;
                    }
                }

                getConfig() {
                    // Configuraci√≥n base que funciona
                    const baseConfig = {
                        appId: '75f7bf03-ba86-4059-99cc-797fe53a147d',
                        allowLocalhostAsSecureOrigin: true,
                        autoRegister: false,  // Manual para mejor control
                        autoResubscribe: false,
                        welcomeNotification: {
                            disable: true
                        }
                    };

                    // Intentar obtener configuraci√≥n personalizada
                    if (window.envConfig && window.envConfig.isConfigured()) {
                        const appId = window.envConfig.get('ONESIGNAL_APP_ID');
                        if (appId && appId !== 'your_app_id_here') {
                            baseConfig.appId = appId;
                            this.log('üîß Usando App ID desde envConfig');
                        }
                    }

                    // Fallback a meta tags
                    const metaAppId = document.querySelector('meta[name="onesignal-app-id"]');
                    if (metaAppId && metaAppId.content && metaAppId.content !== 'your_app_id_here') {
                        baseConfig.appId = metaAppId.content;
                        this.log('üîß Usando App ID desde meta tag');
                    }

                    return baseConfig;
                }

                loadOfficialScript() {
                    this.log('üì° Cargando script oficial OneSignal...');
                    
                    return new Promise((resolve, reject) => {
                        // Verificar si ya existe y est√° funcional
                        const existingScript = document.querySelector('script[src*="OneSignalSDK.page.js"]');
                        if (existingScript && window.OneSignal) {
                            this.log('‚úÖ Script OneSignal ya cargado y funcional');
                            resolve();
                            return;
                        }
                        
                        // Si existe el script pero no OneSignal, removerlo
                        if (existingScript && !window.OneSignal) {
                            this.log('üîÑ Removiendo script no funcional...');
                            existingScript.remove();
                        }
                        
                        // Script oficial de OneSignal (versi√≥n p√°gina)
                        const script = document.createElement('script');
                        script.async = true;
                        script.src = "https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js";
                        
                        script.onload = () => {
                            this.log('‚úÖ Script oficial OneSignal cargado');
                            
                            // Esperar a que OneSignal est√© disponible
                            const checkOneSignal = (attempts = 0) => {
                                if (window.OneSignal) {
                                    this.log('‚úÖ OneSignal SDK disponible');
                                    resolve();
                                } else if (attempts < 50) { // 5 segundos m√°ximo
                                    setTimeout(() => checkOneSignal(attempts + 1), 100);
                                } else {
                                    reject(new Error('OneSignal no disponible despu√©s de cargar script'));
                                }
                            };
                            
                            checkOneSignal();
                        };
                        
                        script.onerror = (error) => {
                            this.log('üí• Error cargando script oficial OneSignal', 'error');
                            reject(new Error('Failed to load OneSignal script'));
                        };
                        
                        // Timeout global
                        setTimeout(() => {
                            if (!window.OneSignal) {
                                reject(new Error('OneSignal script timeout - SDK no disponible'));
                            }
                        }, 15000);
                        
                        document.head.appendChild(script);
                        this.log('üì° Script OneSignal a√±adido al DOM');
                    });
                }

                setupEventHandlers(OneSignal) {
                    this.log('üîß Configurando event handlers...');
                    
                    try {
                        // Event listener para cambios de suscripci√≥n
                        OneSignal.User.PushSubscription.addEventListener('change', (event) => {
                            this.log(`üì± Suscripci√≥n cambi√≥: ${JSON.stringify(event)}`);
                        });

                        // Event listener para notificaciones
                        OneSignal.Notifications.addEventListener('click', (event) => {
                            this.log(`üîî Notificaci√≥n clickeada: ${event.notification.title}`);
                        });

                    } catch (error) {
                        this.log(`‚ö†Ô∏è Error configurando handlers: ${error.message}`, 'error');
                    }
                }

                async checkInitialState(OneSignal) {
                    try {
                        const permission = OneSignal.Notifications.permission;
                        this.log(`üîê Permiso actual: ${permission}`);
                        
                        const id = OneSignal.User.PushSubscription.id;
                        this.log(`üë§ ID actual: ${id || 'null'}`);
                        
                        const optedIn = OneSignal.User.PushSubscription.optedIn;
                        this.log(`üì± Opted In: ${optedIn}`);

                        // Si no hay ID pero est√° opted-in, puede necesitar completar la suscripci√≥n
                        if (optedIn && !id) {
                            this.log('‚ö†Ô∏è Usuario opted-in pero sin ID de suscripci√≥n');
                        }
                        
                    } catch (error) {
                        this.log(`‚ö†Ô∏è Error verificando estado inicial: ${error.message}`, 'error');
                    }
                }

                async subscribe() {
                    try {
                        if (!window.OneSignal) {
                            throw new Error('OneSignal no est√° inicializado');
                        }

                        // Primero verificar permisos
                        const permission = OneSignal.Notifications.permission;
                        if (permission !== 'granted') {
                            this.log('üîê Solicitando permisos primero...');
                            const permissionResult = await OneSignal.Notifications.requestPermission();
                            if (permissionResult !== 'granted') {
                                throw new Error('Permisos no concedidos');
                            }
                        }

                        const optedIn = OneSignal.User.PushSubscription.optedIn;
                        this.log(`üì± Estado opt-in actual: ${optedIn}`);

                        if (!optedIn) {
                            this.log('üîî Realizando opt-in...');
                            await OneSignal.User.PushSubscription.optIn();
                            this.log('‚úÖ Opt-in completado');
                        }

                        // Esperar un momento para que se genere el ID
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        const id = OneSignal.User.PushSubscription.id;
                        this.log(`üë§ ID de suscripci√≥n: ${id || 'null'}`);
                        
                        if (!id) {
                            this.log('‚ö†Ô∏è ID de suscripci√≥n a√∫n es null - puede necesitar m√°s tiempo');
                        }
                        
                        return id;

                    } catch (error) {
                        this.log(`üí• Error en suscripci√≥n: ${error.message}`, 'error');
                        throw error;
                    }
                }

                async unsubscribe() {
                    try {
                        if (!window.OneSignal) {
                            throw new Error('OneSignal no est√° inicializado');
                        }

                        await OneSignal.User.PushSubscription.optOut();
                        this.log('üì± Suscripci√≥n cancelada');

                    } catch (error) {
                        this.log(`üí• Error cancelando suscripci√≥n: ${error.message}`, 'error');
                        throw error;
                    }
                }
            }

            // Exportar para uso global
            window.OneSignalManager = OneSignalManager;
            console.log('üì¶ OneSignalManager exportado a window.OneSignalManager');

            // Auto-inicializaci√≥n cuando se carga el DOM
            document.addEventListener('DOMContentLoaded', () => {
                console.log('üîÑ DOM cargado, iniciando OneSignal...');
                
                const manager = new OneSignalManager();
                window.oneSignalManager = manager;
                
                console.log('üîß OneSignalManager asignado a window.oneSignalManager');
                
                // Intentar inicializaci√≥n con reintentos
                const initWithRetry = async (attempt = 1, maxAttempts = 3) => {
                    try {
                        console.log(`üîÑ Intento de inicializaci√≥n OneSignal #${attempt}`);
                        await manager.initialize();
                        console.log('‚úÖ OneSignal inicializado autom√°ticamente');
                        
                        // Disparar evento personalizado para indicar que est√° listo
                        window.dispatchEvent(new CustomEvent('oneSignalReady', {
                            detail: { manager: manager }
                        }));
                        
                    } catch (error) {
                        console.error(`‚ùå Error en inicializaci√≥n OneSignal (intento ${attempt}):`, error);
                        
                        if (attempt < maxAttempts) {
                            console.log(`üîÑ Reintentando en ${attempt * 2} segundos...`);
                            setTimeout(() => initWithRetry(attempt + 1, maxAttempts), attempt * 2000);
                        } else {
                            console.error('üí• Todos los intentos de inicializaci√≥n OneSignal fallaron');
                            // Mostrar tarjeta de debug autom√°ticamente
                            const debugCard = document.getElementById('debug-card');
                            if (debugCard) {
                                debugCard.style.display = 'block';
                            }
                        }
                    }
                };
                
                initWithRetry();
            });

            console.log('üì¶ OneSignal integrado cargado completamente');
            
            // Funci√≥n de verificaci√≥n peri√≥dica de OneSignal
            function startOneSignalHealthCheck() {
                console.log('üîç Iniciando verificaci√≥n peri√≥dica de OneSignal...');
                
                setInterval(() => {
                    if (window.oneSignalManager && window.oneSignalManager.isInitialized) {
                        // Todo OK, no hacer nada
                        return;
                    }
                    
                    // Si OneSignal no est√° inicializado despu√©s de 30 segundos, intentar recuperar
                    console.warn('‚ö†Ô∏è OneSignal no inicializado en verificaci√≥n peri√≥dica');
                    
                    if (window.oneSignalManager && !window.oneSignalManager.isInitialized) {
                        console.log('üîÑ Intentando reinicializar OneSignal...');
                        window.oneSignalManager.initialize().catch(error => {
                            console.error('‚ùå Error en reinicializaci√≥n autom√°tica:', error);
                        });
                    }
                }, 30000); // Verificar cada 30 segundos
            }
            
            // Iniciar verificaci√≥n despu√©s de 1 minuto
            setTimeout(startOneSignalHealthCheck, 60000);
        </script>

        <!-- Custom JS -->
        <script src="js/alertas.js"></script>

        <!-- Vibration Test Script -->
        <script>
            // Sistema completo de prueba de vibraci√≥n
            let vibrationInfo = {};
            
            function detectDevice() {
                const userAgent = navigator.userAgent.toLowerCase();
                const deviceInfo = {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    isAndroid: /android/i.test(userAgent),
                    isIOS: /iphone|ipad|ipod/i.test(userAgent),
                    isMobile: /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent),
                    isChrome: /chrome/i.test(userAgent) && !/edge/i.test(userAgent),
                    isFirefox: /firefox/i.test(userAgent),
                    isSamsung: /samsung/i.test(userAgent),
                    hasVibrate: 'vibrate' in navigator,
                    hasWebkitVibrate: 'webkitVibrate' in navigator,
                    isHTTPS: location.protocol === 'https:',
                    touchSupport: 'ontouchstart' in window
                };
                
                vibrationInfo = deviceInfo;
                return deviceInfo;
            }
            
            function showDeviceInfo() {
                const info = detectDevice();
                const infoText = `
üîç INFORMACI√ìN DEL DISPOSITIVO:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üì± Dispositivo: ${info.platform}
ü§ñ Android: ${info.isAndroid ? '‚úÖ' : '‚ùå'}
üçé iOS: ${info.isIOS ? '‚úÖ' : '‚ùå'}
üì≤ M√≥vil: ${info.isMobile ? '‚úÖ' : '‚ùå'}
üîí HTTPS: ${info.isHTTPS ? '‚úÖ' : '‚ùå'}
üëÜ Touch: ${info.touchSupport ? '‚úÖ' : '‚ùå'}

üåê NAVEGADOR:
${info.isChrome ? '‚úÖ Chrome' : '‚ùå Chrome'}
${info.isFirefox ? '‚úÖ Firefox' : '‚ùå Firefox'}
${info.isSamsung ? '‚úÖ Samsung' : '‚ùå Samsung'}

üì≥ VIBRACI√ìN:
navigator.vibrate: ${info.hasVibrate ? '‚úÖ' : '‚ùå'}
navigator.webkitVibrate: ${info.hasWebkitVibrate ? '‚úÖ' : '‚ùå'}

üîß User Agent:
${info.userAgent}
                `.trim();
                
                console.log(infoText);
                alert(infoText);
            }
            
            function testVibrationNow() {
                console.log('üì≥ === INICIANDO PRUEBA DE VIBRACI√ìN ===');
                
                const info = detectDevice();
                
                // Mostrar informaci√≥n del dispositivo primero
                console.log('üì± Informaci√≥n del dispositivo:', info);
                
                // Verificaciones previas
                if (info.isIOS) {
                    alert('‚ö†Ô∏è iOS no soporta vibraci√≥n web\n\nLos dispositivos iPhone/iPad no permiten vibraci√≥n desde navegadores web.');
                    return;
                }
                
                if (!info.isMobile) {
                    alert('‚ö†Ô∏è Solo funciona en dispositivos m√≥viles\n\nLa vibraci√≥n web solo est√° disponible en tel√©fonos y tablets.');
                    return;
                }
                
                if (!info.isHTTPS && location.hostname !== 'localhost') {
                    alert('‚ö†Ô∏è Requiere HTTPS\n\nLa vibraci√≥n web solo funciona en conexiones seguras (HTTPS).');
                    return;
                }
                
                if (!info.hasVibrate && !info.hasWebkitVibrate) {
                    alert('‚ùå Tu navegador no soporta vibraci√≥n\n\nIntenta usar Chrome o Firefox en Android.');
                    return;
                }
                
                // M√∫ltiples pruebas de vibraci√≥n
                try {
                    console.log('üîÑ Ejecutando pruebas de vibraci√≥n...');
                    
                    // Prueba 1: Vibraci√≥n simple
                    console.log('üì≥ Prueba 1: Vibraci√≥n simple (200ms)');
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    
                    setTimeout(() => {
                        // Prueba 2: Vibraci√≥n con patr√≥n
                        console.log('üì≥ Prueba 2: Patr√≥n de vibraci√≥n');
                        const pattern = [100, 50, 100, 50, 200];
                        if (navigator.vibrate) {
                            navigator.vibrate(pattern);
                        } else if (navigator.webkitVibrate) {
                            navigator.webkitVibrate(pattern);
                        }
                    }, 1000);
                    
                    setTimeout(() => {
                        // Prueba 3: Vibraci√≥n larga
                        console.log('üì≥ Prueba 3: Vibraci√≥n larga (500ms)');
                        if (navigator.vibrate) {
                            navigator.vibrate(500);
                        }
                    }, 3000);
                    
                    // Mostrar resultado
                    const resultMsg = `
üì≥ PRUEBAS DE VIBRACI√ìN ENVIADAS

‚úÖ Se ejecutaron 3 pruebas:
1Ô∏è‚É£ Vibraci√≥n simple (200ms)
2Ô∏è‚É£ Patr√≥n: 100-50-100-50-200ms  
3Ô∏è‚É£ Vibraci√≥n larga (500ms)

üîß DIAGN√ìSTICO:
${info.isAndroid ? '‚úÖ' : '‚ùå'} Android detectado
${info.hasVibrate ? '‚úÖ' : '‚ùå'} API vibrate disponible
${info.isHTTPS ? '‚úÖ' : '‚ùå'} Conexi√≥n HTTPS
${info.isChrome ? '‚úÖ' : '‚ùå'} Chrome (recomendado)

üí° SI NO VIBR√ì, VERIFICA:
‚Ä¢ Vibraci√≥n habilitada en ajustes del tel√©fono
‚Ä¢ Modo silencio/vibraci√≥n del tel√©fono
‚Ä¢ Permisos del navegador para el sitio
‚Ä¢ Usar Chrome en Android es lo m√°s compatible

üîç Ver consola (F12) para m√°s detalles
                    `;
                    
                    alert(resultMsg);
                    
                } catch (error) {
                    console.error('‚ùå Error en vibraci√≥n:', error);
                    alert(`‚ùå ERROR EN VIBRACI√ìN:\n\n${error.message}\n\nRevisa la consola (F12) para m√°s detalles.`);
                }
            }
            
            // Funci√≥n para prueba b√°sica sin alertas
            function testVibrationSilent() {
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                    console.log('üì≥ Vibraci√≥n silenciosa enviada');
                    return true;
                }
                return false;
            }
            
            // Agregar m√∫ltiples botones de prueba
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üîß Configurando botones de vibraci√≥n...');
                
                // Bot√≥n principal de prueba
                const testBtn = document.getElementById('test-vibration');
                if (testBtn) {
                    testBtn.addEventListener('click', testVibrationNow);
                    console.log('‚úÖ Bot√≥n principal de vibraci√≥n configurado');
                }
                
                // Agregar bot√≥n de informaci√≥n del dispositivo despu√©s del bot√≥n de prueba
                const vibrationDiv = testBtn?.parentNode;
                if (vibrationDiv) {
                    const infoBtn = document.createElement('button');
                    infoBtn.type = 'button';
                    infoBtn.className = 'btn btn-outline-info btn-sm ms-2';
                    infoBtn.innerHTML = '<i class="fas fa-info-circle me-1"></i>Info Dispositivo';
                    infoBtn.addEventListener('click', showDeviceInfo);
                    
                    vibrationDiv.appendChild(infoBtn);
                    console.log('‚úÖ Bot√≥n de informaci√≥n agregado');
                }
                
                // Detectar dispositivo al cargar
                const deviceInfo = detectDevice();
                console.log('üì± Dispositivo detectado:', deviceInfo);
                
                // Prueba autom√°tica silenciosa en m√≥viles Android
                if (deviceInfo.isAndroid && deviceInfo.hasVibrate) {
                    setTimeout(() => {
                        console.log('üîÑ Realizando prueba autom√°tica silenciosa...');
                        testVibrationSilent();
                    }, 2000);
                }
            });
        </script>

        <!-- OneSignal Initialization -->
        <script>
            // Inicializar OneSignal en la p√°gina principal
            document.addEventListener('DOMContentLoaded', async () => {
                console.log('[App] üöÄ Inicializando aplicaci√≥n...');
                
                // Escuchar evento de OneSignal listo
                window.addEventListener('oneSignalReady', (event) => {
                    console.log('[App] ‚úÖ OneSignal est√° listo');
                    const manager = event.detail.manager;
                    
                    // Actualizar UI de notificaciones push
                    updatePushNotificationUI(manager);
                });
                
                // Fallback si oneSignalManager ya est√° disponible
                if (window.oneSignalManager && window.oneSignalManager.isInitialized) {
                    console.log('[App] ‚úÖ OneSignal ya inicializado');
                    updatePushNotificationUI(window.oneSignalManager);
                }
            });
            
            function updatePushNotificationUI(manager) {
                const pushCheckbox = document.getElementById('push-notifications-enabled');
                const pushStatus = document.getElementById('push-status');
                
                // Verificar estado actual
                if (window.OneSignal) {
                    const optedIn = OneSignal.User.PushSubscription.optedIn;
                    
                    if (pushCheckbox) pushCheckbox.checked = optedIn;
                    if (pushStatus && optedIn) {
                        pushStatus.style.display = 'block';
                        pushStatus.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Notificaciones habilitadas</span>';
                    }
                    
                    // Sincronizar con alertas.js
                    window.dispatchEvent(new CustomEvent('pushNotificationsEnabled', {
                        detail: { enabled: optedIn }
                    }));
                }
            }

            // Funci√≥n para manejar el checkbox de notificaciones push
            document.addEventListener('DOMContentLoaded', () => {
                const pushCheckbox = document.getElementById('push-notifications-enabled');
                if (pushCheckbox) {
                    pushCheckbox.addEventListener('change', async (e) => {
                        if (e.target.checked) {
                            console.log('[App] üîî Solicitando suscripci√≥n a notificaciones...');
                            if (window.oneSignalManager && window.oneSignalManager.isInitialized) {
                                try {
                                    await window.oneSignalManager.subscribe();
                                    const pushStatus = document.getElementById('push-status');
                                    if (pushStatus) {
                                        pushStatus.style.display = 'block';
                                        pushStatus.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Notificaciones habilitadas</span>';
                                    }
                                    
                                    // Disparar evento personalizado para sincronizar con alertas.js
                                    window.dispatchEvent(new CustomEvent('pushNotificationsEnabled', {
                                        detail: { enabled: true }
                                    }));
                                    
                                } catch (error) {
                                    console.error('[App] ‚ùå Error en suscripci√≥n:', error);
                                    e.target.checked = false;
                                    alert('Error activando notificaciones: ' + error.message);
                                }
                            } else {
                                console.warn('[App] ‚ö†Ô∏è OneSignal no inicializado');
                                e.target.checked = false;
                                alert('OneSignal no est√° inicializado. Por favor, recarga la p√°gina.');
                            }
                        } else {
                            // Desuscribir
                            if (window.oneSignalManager && window.oneSignalManager.isInitialized) {
                                try {
                                    await window.oneSignalManager.unsubscribe();
                                    const pushStatus = document.getElementById('push-status');
                                    if (pushStatus) {
                                        pushStatus.style.display = 'none';
                                    }
                                    
                                    // Disparar evento personalizado para sincronizar con alertas.js
                                    window.dispatchEvent(new CustomEvent('pushNotificationsEnabled', {
                                        detail: { enabled: false }
                                    }));
                                    
                                } catch (error) {
                                    console.error('[App] ‚ùå Error cancelando suscripci√≥n:', error);
                                }
                            }
                        }
                    });
                }

                // Mostrar tarjeta de debug si hay problemas
                setTimeout(() => {
                    if (!window.oneSignalManager || !window.oneSignalManager.isInitialized) {
                        console.warn('[App] ‚ö†Ô∏è OneSignal no inicializado despu√©s de 10 segundos, mostrando debug');
                        
                        // Ejecutar diagn√≥stico autom√°tico
                        const debugInfo = debugOneSignal();
                        
                        // Mostrar tarjeta de debug
                        const debugCard = document.getElementById('debug-card');
                        if (debugCard) {
                            debugCard.style.display = 'block';
                            
                            // A√±adir informaci√≥n del diagn√≥stico al debug card
                            const debugBody = debugCard.querySelector('.card-body');
                            if (debugBody && !debugBody.querySelector('.auto-debug')) {
                                const autoDebugDiv = document.createElement('div');
                                autoDebugDiv.className = 'auto-debug mt-3 pt-3 border-top';
                                autoDebugDiv.innerHTML = `
                                    <small class="text-warning">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        <strong>Diagn√≥stico Autom√°tico:</strong><br>
                                        ‚Ä¢ Script cargado: ${debugInfo.scriptLoaded ? '‚úÖ' : '‚ùå'}<br>
                                        ‚Ä¢ Manager disponible: ${debugInfo.oneSignalManager ? '‚úÖ' : '‚ùå'}<br>
                                        ‚Ä¢ HTTPS: ${debugInfo.isHTTPS ? '‚úÖ' : '‚ùå'}<br>
                                        ‚Ä¢ Hostname: ${debugInfo.hostname}
                                    </small>
                                `;
                                debugBody.appendChild(autoDebugDiv);
                            }
                        }
                    }
                }, 10000);
            });

            // Funciones de debug para OneSignal
            function debugOneSignal() {
                console.log('üîç === DEBUG ONESIGNAL DETALLADO ===');
                
                const debugInfo = {
                    oneSignalManager: !!window.oneSignalManager,
                    managerInitialized: window.oneSignalManager ? window.oneSignalManager.isInitialized : false,
                    oneSignalSDK: !!window.OneSignal,
                    oneSignalDeferred: !!window.OneSignalDeferred,
                    deferredLength: window.OneSignalDeferred ? window.OneSignalDeferred.length : 0,
                    scriptLoaded: !!document.querySelector('script[src*="OneSignalSDK.page.js"]'),
                    isHTTPS: location.protocol === 'https:',
                    hostname: location.hostname,
                    timestamp: new Date().toISOString()
                };
                
                console.log('üìä Estado de OneSignal:', debugInfo);
                
                // Verificar el script espec√≠ficamente
                const script = document.querySelector('script[src*="OneSignalSDK.page.js"]');
                if (script) {
                    console.log('üìú Script OneSignal encontrado:');
                    console.log('- Src:', script.src);
                    console.log('- Async:', script.async);
                    console.log('- Loaded:', script.readyState || 'unknown');
                }
                
                // Verificar objetos globales relacionados
                console.log('üåê Objetos globales:');
                console.log('- window.OneSignal:', typeof window.OneSignal);
                console.log('- window.OneSignalDeferred:', typeof window.OneSignalDeferred);
                console.log('- window.oneSignalManager:', typeof window.oneSignalManager);
                
                if (window.OneSignal) {
                    console.log('‚úÖ OneSignal SDK disponible - verificando funcionalidad...');
                    
                    try {
                        // Verificar m√©todos principales
                        const hasInit = typeof window.OneSignal.init === 'function';
                        const hasNotifications = !!window.OneSignal.Notifications;
                        const hasUser = !!window.OneSignal.User;
                        
                        console.log('üîß M√©todos OneSignal:');
                        console.log('- init():', hasInit);
                        console.log('- Notifications:', hasNotifications);
                        console.log('- User:', hasUser);
                        
                        if (hasNotifications && hasUser) {
                            const permission = OneSignal.Notifications.permission;
                            const optedIn = OneSignal.User.PushSubscription.optedIn;
                            const id = OneSignal.User.PushSubscription.id;
                            
                            console.log('üì± Estado OneSignal:');
                            console.log('- Permiso:', permission);
                            console.log('- Opted In:', optedIn);
                            console.log('- ID:', id);
                            
                            const statusMsg = `OneSignal Debug Completo:

‚úÖ SDK DISPONIBLE Y FUNCIONAL

Estado de Suscripci√≥n:
‚Ä¢ Permiso: ${permission}
‚Ä¢ Opted In: ${optedIn}
‚Ä¢ ID: ${id || 'null'}

Estado T√©cnico:
‚Ä¢ Script Cargado: ${debugInfo.scriptLoaded ? '‚úÖ' : '‚ùå'}
‚Ä¢ Manager Init: ${debugInfo.managerInitialized ? '‚úÖ' : '‚ùå'}
‚Ä¢ HTTPS: ${debugInfo.isHTTPS ? '‚úÖ' : '‚ùå'}
‚Ä¢ Deferred Queue: ${debugInfo.deferredLength} items
‚Ä¢ Hostname: ${debugInfo.hostname}

M√©todos Verificados:
‚Ä¢ init(): ${hasInit ? '‚úÖ' : '‚ùå'}
‚Ä¢ Notifications: ${hasNotifications ? '‚úÖ' : '‚ùå'}
‚Ä¢ User: ${hasUser ? '‚úÖ' : '‚ùå'}

${optedIn ? 'üü¢ Todo funciona correctamente' : 'üü° Necesita suscripci√≥n'}`;

                            alert(statusMsg);
                        } else {
                            alert(`OneSignal SDK parcialmente disponible\n\nM√©todos encontrados:\n- init(): ${hasInit}\n- Notifications: ${hasNotifications}\n- User: ${hasUser}\n\nEl SDK puede estar carg√°ndose a√∫n.`);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error verificando OneSignal:', error);
                        alert(`Error verificando OneSignal SDK:\n${error.message}\n\nEl SDK est√° presente pero no responde correctamente.\n\nEstado T√©cnico:\n- Script: ${debugInfo.scriptLoaded}\n- Manager: ${debugInfo.managerInitialized}\n- HTTPS: ${debugInfo.isHTTPS}`);
                    }
                } else {
                    console.log('‚ùå OneSignal SDK no disponible');
                    
                    const detailedMsg = `OneSignal SDK NO DISPONIBLE

Diagn√≥stico Detallado:
‚Ä¢ Script cargado: ${debugInfo.scriptLoaded ? '‚úÖ' : '‚ùå'}
‚Ä¢ Manager disponible: ${debugInfo.oneSignalManager ? '‚úÖ' : '‚ùå'}
‚Ä¢ Manager inicializado: ${debugInfo.managerInitialized ? '‚úÖ' : '‚ùå'}
‚Ä¢ HTTPS: ${debugInfo.isHTTPS ? '‚úÖ' : '‚ùå'}
‚Ä¢ Hostname: ${debugInfo.hostname}
‚Ä¢ Deferred Queue: ${debugInfo.deferredLength} items

${debugInfo.scriptLoaded ? 
'üü° Script cargado pero SDK no disponible\n   ‚Üí Posible error en la carga del SDK' : 
'üî¥ Script no cargado\n   ‚Üí Error de conectividad o bloqueo'}

Soluciones:
1. Recargar la p√°gina
2. Verificar conexi√≥n a internet
3. Desactivar bloqueador de ads
4. Usar modo inc√≥gnito para probar`;
                    
                    alert(detailedMsg);
                }
                
                return debugInfo;
            }
            
            function forceInitOneSignal() {
                console.log('üîÑ Forzando inicializaci√≥n OneSignal...');
                
                // Funci√≥n de prueba de conectividad mejorada
                async function testConnectivity() {
                    console.log('üåê Probando conectividad...');
                    
                    try {
                        // Probar conectividad b√°sica
                        const response = await fetch('https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js', { 
                            method: 'HEAD',
                            cache: 'no-cache'
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        console.log('‚úÖ Conectividad a OneSignal CDN verificada');
                        return true;
                        
                    } catch (error) {
                        console.error('‚ùå Error de conectividad:', error);
                        
                        // Probar conectividad alternativa
                        try {
                            const altResponse = await fetch('https://onesignal.com', { 
                                method: 'HEAD',
                                cache: 'no-cache'
                            });
                            
                            if (altResponse.ok) {
                                console.warn('‚ö†Ô∏è OneSignal.com accesible pero CDN no. Posible bloqueo espec√≠fico.');
                                return false;
                            }
                        } catch (altError) {
                            console.error('‚ùå OneSignal completamente inaccesible');
                        }
                        
                        throw error;
                    }
                }
                
                // Proceder con inicializaci√≥n
                testConnectivity()
                    .then(() => {
                        console.log('‚úÖ Conectividad verificada, procediendo con inicializaci√≥n...');
                        return proceedWithInit();
                    })
                    .catch(error => {
                        console.error('‚ùå Error de conectividad a OneSignal:', error);
                        alert(`Error de conectividad a OneSignal CDN:
${error.message}

Posibles causas:
‚Ä¢ Bloqueador de anuncios activo
‚Ä¢ Firewall corporativo
‚Ä¢ Problemas de conectividad
‚Ä¢ Restricciones de red

Soluciones:
1. Desactivar bloqueador de ads
2. Usar otra red WiFi/datos m√≥viles
3. Modo inc√≥gnito del navegador
4. VPN si hay restricciones geogr√°ficas`);
                    });
                
                function proceedWithInit() {
                    console.log('üîß Procediendo con inicializaci√≥n forzada...');
                    
                    if (window.oneSignalManager) {
                        console.log('üîÑ Reiniciando manager existente...');
                        
                        // Resetear el manager completamente
                        window.oneSignalManager.isInitialized = false;
                        window.oneSignalManager.initPromise = null;
                        
                        // Limpiar script anterior si existe
                        const oldScript = document.querySelector('script[src*="OneSignalSDK.page.js"]');
                        if (oldScript) {
                            console.log('üóëÔ∏è Removiendo script anterior...');
                            oldScript.remove();
                            delete window.OneSignal;
                        }
                        
                        window.oneSignalManager.initialize()
                            .then(() => {
                                console.log('‚úÖ Manager reinicializado exitosamente');
                                alert('‚úÖ OneSignal reinicializado correctamente\n\nPuedes probar las notificaciones ahora.');
                                
                                // Ocultar tarjeta de debug
                                const debugCard = document.getElementById('debug-card');
                                if (debugCard) {
                                    debugCard.style.display = 'none';
                                }
                            })
                            .catch(error => {
                                console.error('‚ùå Error en reinicializaci√≥n:', error);
                                alert(`‚ùå Error en reinicializaci√≥n:\n${error.message}\n\nRevisa la consola para m√°s detalles.`);
                            });
                    } else {
                        console.log('üÜï Creando nuevo manager...');
                        
                        // Crear nuevo manager
                        const manager = new window.OneSignalManager();
                        window.oneSignalManager = manager;
                        
                        manager.initialize()
                            .then(() => {
                                console.log('‚úÖ Nuevo manager creado exitosamente');
                                alert('‚úÖ OneSignal inicializado correctamente\n\nPuedes activar las notificaciones ahora.');
                                
                                // Ocultar tarjeta de debug
                                const debugCard = document.getElementById('debug-card');
                                if (debugCard) {
                                    debugCard.style.display = 'none';
                                }
                            })
                            .catch(error => {
                                console.error('‚ùå Error creando manager:', error);
                                alert(`‚ùå Error creando manager:\n${error.message}\n\nPuede ser un problema de bloqueo o configuraci√≥n.`);
                            });
                    }
                }
            }
        </script>

        <!-- PWA Service Worker -->
        <script>
            // Variable para controlar actualizaciones
            let swUpdateAvailable = false;
            let swRegistration = null;
            
            // Versi√≥n actual de la aplicaci√≥n (cambiar solo cuando queramos forzar actualizaci√≥n)
            const APP_VERSION = '1.2.7';
            
            // Registrar Service Worker para funcionalidad PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js', {
                        // Desactivar actualizaciones autom√°ticas
                        updateViaCache: 'none'
                    })
                        .then(registration => {
                            swRegistration = registration;
                            console.log('‚úÖ PWA Service Worker registrado:', registration.scope);

                            // Establecer versi√≥n inicial
                            localStorage.setItem('app_version', APP_VERSION);
                            console.log('ÔøΩ Versi√≥n establecida:', APP_VERSION);
                            
                        })
                        .catch(error => {
                            console.warn('‚ö†Ô∏è Error registrando PWA Service Worker:', error);
                        });
                }, 2000);

                // Escuchar cambios en el Service Worker
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('üîÑ PWA Service Worker actualizado');
                });
            } else {
                console.warn('‚ö†Ô∏è Service Workers no soportados en este navegador');
            }
            
            // Funci√≥n para verificar actualizaciones manualmente (para uso futuro)
            function checkForUpdates() {
                if (swRegistration) {
                    console.log('üîç Verificando actualizaciones manualmente...');
                    swRegistration.update();
                }
            }
            
            // Funci√≥n para forzar actualizaci√≥n (para desarrollo)
            function forceUpdate() {
                if (confirm('¬øForzar actualizaci√≥n de la aplicaci√≥n?')) {
                    localStorage.removeItem('app_version');
                    window.location.reload(true);
                }
            }
        </script>
    </body>

</html>