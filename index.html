<!DOCTYPE html>
<html lang="es">

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="Shoken - Recordatorios sonoros para práctica consciente" />

        <!-- OneSignal Configuration -->
        <meta name="onesignal-app-id" content="75f7bf03-ba86-4059-99cc-797fe53a147d" />
        <meta name="onesignal-safari-id" content="web.onesignal.auto.3f550615-46c0-4fa5-9ee8-42953ece3d19" />

        <!-- PWA Meta Tags -->
        <meta name="theme-color" content="#2d5a4f">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="Alertas">
        <meta name="msapplication-TileColor" content="#2d5a4f">
        <meta name="msapplication-TileImage" content="/assets/icons/192x192.png">

        <title>Shoken - Camino Medio</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <link rel="apple-touch-icon" href="assets/icons/192x192.png" />
        <link rel="apple-touch-icon" sizes="192x192" href="assets/icons/192x192.png" />
        <link rel="apple-touch-icon" sizes="512x512" href="assets/icons/512x512.png" />

        <!-- OneSignal Push Notifications (Versión Oficial Funcional) -->
        <!-- NO cargar script aquí - lo maneja onesignal-working.js -->

        <!-- Font Awesome icons -->
        <script defer src="https://use.fontawesome.com/releases/v6.5.2/js/all.js"></script>

        <!-- Google fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" />

        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="css/alertas.css" rel="stylesheet" />
        <link rel="manifest" href="/manifest.json">
    </head>

    <body class="bg-dark text-white">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-black fixed-top">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="index.html">
                    <img src="assets/icons/logoblanco.png" alt="Camino Medio" height="40" class="me-3">
                    <span class="text-white">Camino Medio</span>
                </a>
                <h4 class="text-white mb-0 ms-auto">Atención Plena</h4>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mt-5 pt-5">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <!-- Status Card -->
                    <div class="card bg-dark border-light mb-4">
                        <div class="card-body text-center">
                            <div id="status-indicator" class="status-inactive mb-3">
                                <i class="fas fa-bell-slash fa-3x"></i>
                            </div>
                            <h3 id="status-text">Alertas Desactivadas</h3>
                            <p id="next-alert" class="text-muted"></p>
                            <button id="toggle-btn" class="btn btn-primary btn-lg">
                                <i class="fas fa-play me-2"></i>Activar Alertas
                            </button>
                        </div>
                    </div>

                    <!-- Configuration Card -->
                    <div class="card bg-dark border-light mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Configuración</h5>
                        </div>
                        <div class="card-body">
                            <!-- Interval Settings -->
                            <div class="mb-4">
                                <label class="form-label">Intervalo de tiempo</label>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="interval-minutes" class="form-label small">Minutos</label>
                                        <input type="number" class="form-control" id="interval-minutes" min="0" max="59"
                                            value="5">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="interval-seconds" class="form-label small">Segundos</label>
                                        <input type="number" class="form-control" id="interval-seconds" min="0" max="59"
                                            value="0">
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex flex-column h-100">
                                            <label class="form-label small">Presets</label>
                                            <select class="form-select" id="preset-intervals">
                                                <option value="">Personalizado</option>
                                                <option value="30">30 segundos</option>
                                                <option value="60">1 minuto</option>
                                                <option value="300">5 minutos</option>
                                                <option value="600">10 minutos</option>
                                                <option value="900">15 minutos</option>
                                                <option value="1800">30 minutos</option>
                                                <option value="3600">1 hora</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sound Settings -->
                            <div class="mb-4">
                                <label class="form-label">Sonido de alerta</label>
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <select class="form-select" id="sound-select">
                                            <option value="bell1">Cuenco Zen</option>
                                            <option value="bell2">Gong Suave</option>
                                            <option value="bell3">Cuenco Tibetano</option>
                                            <option value="bell4">Carillón</option>
                                            <option value="bell5">Om Mantra</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-outline-light w-100" id="test-sound">
                                            <i class="fas fa-volume-up me-2"></i>Probar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Volume Control -->
                            <div class="mb-4">
                                <label for="volume-control" class="form-label">Volumen</label>
                                <input type="range" class="form-range" id="volume-control" min="0" max="100" value="70">
                                <div class="d-flex justify-content-between small text-muted">
                                    <span>0%</span>
                                    <span id="volume-display">70%</span>
                                    <span>100%</span>
                                </div>
                            </div>

                            <!-- Vibration Settings -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="vibration-enabled">
                                    <label class="form-check-label" for="vibration-enabled">
                                        <i class="fas fa-mobile-alt me-2"></i>Activar vibración (móviles)
                                    </label>
                                </div>
                            </div>

                            <!-- Push Notifications Settings -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="push-notifications-enabled">
                                    <label class="form-check-label" for="push-notifications-enabled">
                                        <i class="fas fa-bell me-2"></i>Notificaciones Push (funciona con teléfono
                                        inactivo)
                                    </label>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Las notificaciones push permiten recibir alertas aunque la app esté cerrada
                                    </small>
                                </div>
                                <div id="push-status" class="mt-2" style="display: none;">
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Notificaciones habilitadas
                                    </span>
                                </div>
                            </div>

                            <!-- Auto-stop Settings -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto-stop-enabled">
                                    <label class="form-check-label" for="auto-stop-enabled">
                                        Parar automáticamente después de:
                                    </label>
                                </div>
                                <div class="mt-2">
                                    <select class="form-select" id="auto-stop-duration" disabled>
                                        <option value="10">10 alertas</option>
                                        <option value="20">20 alertas</option>
                                        <option value="30">30 alertas</option>
                                        <option value="60">1 hora</option>
                                        <option value="120">2 horas</option>
                                        <option value="180">3 horas</option>
                                    </select>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="button" class="btn btn-success" id="save-config">
                                    <i class="fas fa-save me-2"></i>Guardar Configuración
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Card -->
                    <div class="card bg-dark border-light">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Estadísticas de Hoy</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="stat-item">
                                        <h3 id="alerts-count" class="text-primary">0</h3>
                                        <small class="text-muted">Alertas Recibidas</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-item">
                                        <h3 id="session-time" class="text-success">0m</h3>
                                        <small class="text-muted">Tiempo de Sesión</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-item">
                                        <h3 id="mindful-moments" class="text-warning">0</h3>
                                        <small class="text-muted">Momentos Conscientes</small>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-outline-light btn-sm" id="reset-stats">
                                    <i class="fas fa-redo me-2"></i>Reiniciar Estadísticas
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Debug OneSignal Card (temporal) -->
                    <div class="card bg-dark border-warning mb-4" id="debug-card" style="display: none;">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-bug me-2"></i>Debug OneSignal</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-warning btn-sm w-100" onclick="debugOneSignal()">
                                        <i class="fas fa-info me-1"></i>Estado OneSignal
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-warning btn-sm w-100" onclick="forceInitOneSignal()">
                                        <i class="fas fa-sync me-1"></i>Forzar Init
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Presiona F12 para ver la consola del navegador
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center py-4 mt-5">
            <div class="container">
                <p class="text-muted mb-0">
                    <i class="fas fa-om me-2"></i>
                    Practica la atención plena momento a momento
                </p>
                <a href="../index.html" class="btn btn-outline-light btn-sm mt-2">
                    <i class="fas fa-arrow-left me-2"></i>Volver al Inicio
                </a>
            </div>
        </footer>

        <!-- Audio Elements -->
        <audio id="alert-audio" preload="auto">
            <source id="audio-source" src="sounds/bell1.mp3" type="audio/mpeg">
        </audio>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Configuración de entorno -->
        <script src="js/env-config.js"></script>

        <!-- OneSignal Configuration (Integrado Directamente) -->
        <script>
            console.log('📦 Iniciando OneSignal integrado...');
            
            // OneSignal Manager integrado directamente
            class OneSignalManager {
                constructor() {
                    console.log('🏗️ Creando OneSignalManager...');
                    this.isInitialized = false;
                    this.initPromise = null;
                    this.debug = true;
                }

                log(message, level = 'info') {
                    if (this.debug) {
                        const timestamp = new Date().toISOString();
                        console.log(`[${timestamp}] [OneSignal] ${message}`);
                    }
                }

                async initialize() {
                    if (this.initPromise) {
                        return this.initPromise;
                    }

                    this.initPromise = this._doInitialize();
                    return this.initPromise;
                }

                async _doInitialize() {
                    return new Promise((resolve, reject) => {
                        try {
                            this.log('🚀 Iniciando configuración oficial OneSignal...');
                            
                            // Verificar protocolo HTTPS
                            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                                throw new Error('OneSignal requiere HTTPS');
                            }

                            // Obtener configuración
                            const config = this.getConfig();
                            this.log('🔧 Configuración:');
                            this.log(JSON.stringify(config, null, 2));

                            // Configurar OneSignalDeferred antes de cargar el script
                            window.OneSignalDeferred = window.OneSignalDeferred || [];
                            
                            window.OneSignalDeferred.push((OneSignal) => {
                                this.log('📦 OneSignal SDK cargado via deferred');
                                
                                OneSignal.init(config).then(() => {
                                    this.log('✅ OneSignal inicializado correctamente');
                                    this.isInitialized = true;
                                    this.setupEventHandlers(OneSignal);
                                    
                                    // Verificar estado inicial
                                    this.checkInitialState(OneSignal);
                                    
                                    resolve(OneSignal);
                                    
                                }).catch(error => {
                                    this.log(`💥 Error en inicialización: ${error.message}`, 'error');
                                    reject(error);
                                });
                            });

                            // Cargar el script oficial si no está ya cargado
                            if (!document.querySelector('script[src*="OneSignalSDK.page.js"]')) {
                                this.loadOfficialScript();
                            }
                            
                            // Timeout de seguridad
                            setTimeout(() => {
                                if (!this.isInitialized) {
                                    reject(new Error('Timeout: OneSignal no se inicializó en 15 segundos'));
                                }
                            }, 15000);

                        } catch (error) {
                            this.log(`💥 Error en configuración: ${error.message}`, 'error');
                            reject(error);
                        }
                    });
                }

                getConfig() {
                    // Configuración base que funciona
                    const baseConfig = {
                        appId: '75f7bf03-ba86-4059-99cc-797fe53a147d',
                        allowLocalhostAsSecureOrigin: true,
                        autoRegister: false,  // Manual para mejor control
                        autoResubscribe: false,
                        welcomeNotification: {
                            disable: true
                        }
                    };

                    // Intentar obtener configuración personalizada
                    if (window.envConfig && window.envConfig.isConfigured()) {
                        const appId = window.envConfig.get('ONESIGNAL_APP_ID');
                        if (appId && appId !== 'your_app_id_here') {
                            baseConfig.appId = appId;
                            this.log('🔧 Usando App ID desde envConfig');
                        }
                    }

                    // Fallback a meta tags
                    const metaAppId = document.querySelector('meta[name="onesignal-app-id"]');
                    if (metaAppId && metaAppId.content && metaAppId.content !== 'your_app_id_here') {
                        baseConfig.appId = metaAppId.content;
                        this.log('🔧 Usando App ID desde meta tag');
                    }

                    return baseConfig;
                }

                loadOfficialScript() {
                    this.log('📡 Cargando script oficial OneSignal...');
                    
                    // Script oficial de OneSignal (versión página)
                    (function(l, e, a, r, n, i, ng, g) {
                        if (!l[n]) {
                            function d(o) {
                                return o.getElementsByTagName(r)[0];
                            }
                            var f = e.createElement(r);
                            f.async = 1;
                            f.src = a;
                            f.onload = function() {
                                console.log('[OneSignal] Script oficial cargado completamente');
                            };
                            f.onerror = function() {
                                console.error('[OneSignal] Error cargando script oficial');
                            };
                            d(e).parentNode.insertBefore(f, d(e));
                        }
                    })(window, document, "https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js", "script", "OneSignal");
                }

                setupEventHandlers(OneSignal) {
                    this.log('🔧 Configurando event handlers...');
                    
                    try {
                        // Event listener para cambios de suscripción
                        OneSignal.User.PushSubscription.addEventListener('change', (event) => {
                            this.log(`📱 Suscripción cambió: ${JSON.stringify(event)}`);
                        });

                        // Event listener para notificaciones
                        OneSignal.Notifications.addEventListener('click', (event) => {
                            this.log(`🔔 Notificación clickeada: ${event.notification.title}`);
                        });

                    } catch (error) {
                        this.log(`⚠️ Error configurando handlers: ${error.message}`, 'error');
                    }
                }

                async checkInitialState(OneSignal) {
                    try {
                        const permission = OneSignal.Notifications.permission;
                        this.log(`🔐 Permiso actual: ${permission}`);
                        
                        const id = OneSignal.User.PushSubscription.id;
                        this.log(`👤 ID actual: ${id || 'null'}`);
                        
                        const optedIn = OneSignal.User.PushSubscription.optedIn;
                        this.log(`📱 Opted In: ${optedIn}`);

                        // Si no hay ID pero está opted-in, puede necesitar completar la suscripción
                        if (optedIn && !id) {
                            this.log('⚠️ Usuario opted-in pero sin ID de suscripción');
                        }
                        
                    } catch (error) {
                        this.log(`⚠️ Error verificando estado inicial: ${error.message}`, 'error');
                    }
                }

                async subscribe() {
                    try {
                        if (!window.OneSignal) {
                            throw new Error('OneSignal no está inicializado');
                        }

                        // Primero verificar permisos
                        const permission = OneSignal.Notifications.permission;
                        if (permission !== 'granted') {
                            this.log('🔐 Solicitando permisos primero...');
                            const permissionResult = await OneSignal.Notifications.requestPermission();
                            if (permissionResult !== 'granted') {
                                throw new Error('Permisos no concedidos');
                            }
                        }

                        const optedIn = OneSignal.User.PushSubscription.optedIn;
                        this.log(`📱 Estado opt-in actual: ${optedIn}`);

                        if (!optedIn) {
                            this.log('🔔 Realizando opt-in...');
                            await OneSignal.User.PushSubscription.optIn();
                            this.log('✅ Opt-in completado');
                        }

                        // Esperar un momento para que se genere el ID
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        const id = OneSignal.User.PushSubscription.id;
                        this.log(`👤 ID de suscripción: ${id || 'null'}`);
                        
                        if (!id) {
                            this.log('⚠️ ID de suscripción aún es null - puede necesitar más tiempo');
                        }
                        
                        return id;

                    } catch (error) {
                        this.log(`💥 Error en suscripción: ${error.message}`, 'error');
                        throw error;
                    }
                }

                async unsubscribe() {
                    try {
                        if (!window.OneSignal) {
                            throw new Error('OneSignal no está inicializado');
                        }

                        await OneSignal.User.PushSubscription.optOut();
                        this.log('📱 Suscripción cancelada');

                    } catch (error) {
                        this.log(`💥 Error cancelando suscripción: ${error.message}`, 'error');
                        throw error;
                    }
                }
            }

            // Exportar para uso global
            window.OneSignalManager = OneSignalManager;
            console.log('📦 OneSignalManager exportado a window.OneSignalManager');

            // Auto-inicialización cuando se carga el DOM
            document.addEventListener('DOMContentLoaded', () => {
                console.log('🔄 DOM cargado, iniciando OneSignal...');
                
                const manager = new OneSignalManager();
                window.oneSignalManager = manager;
                
                console.log('🔧 OneSignalManager asignado a window.oneSignalManager');
                
                manager.initialize().then(() => {
                    console.log('✅ OneSignal inicializado automáticamente');
                    
                    // Disparar evento personalizado para indicar que está listo
                    window.dispatchEvent(new CustomEvent('oneSignalReady', {
                        detail: { manager: manager }
                    }));
                    
                }).catch(error => {
                    console.error('❌ Error en auto-inicialización OneSignal:', error);
                });
            });

            console.log('📦 OneSignal integrado cargado completamente');
        </script>

        <!-- Custom JS -->
        <script src="js/alertas.js"></script>

        <!-- OneSignal Initialization -->
        <script>
            // Inicializar OneSignal en la página principal
            document.addEventListener('DOMContentLoaded', async () => {
                console.log('[App] 🚀 Inicializando aplicación...');
                
                // Escuchar evento de OneSignal listo
                window.addEventListener('oneSignalReady', (event) => {
                    console.log('[App] ✅ OneSignal está listo');
                    const manager = event.detail.manager;
                    
                    // Actualizar UI de notificaciones push
                    updatePushNotificationUI(manager);
                });
                
                // Fallback si oneSignalManager ya está disponible
                if (window.oneSignalManager && window.oneSignalManager.isInitialized) {
                    console.log('[App] ✅ OneSignal ya inicializado');
                    updatePushNotificationUI(window.oneSignalManager);
                }
            });
            
            function updatePushNotificationUI(manager) {
                const pushCheckbox = document.getElementById('push-notifications-enabled');
                const pushStatus = document.getElementById('push-status');
                
                // Verificar estado actual
                if (window.OneSignal) {
                    const optedIn = OneSignal.User.PushSubscription.optedIn;
                    
                    if (pushCheckbox) pushCheckbox.checked = optedIn;
                    if (pushStatus && optedIn) {
                        pushStatus.style.display = 'block';
                        pushStatus.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Notificaciones habilitadas</span>';
                    }
                }
            }

            // Función para manejar el checkbox de notificaciones push
            document.addEventListener('DOMContentLoaded', () => {
                const pushCheckbox = document.getElementById('push-notifications-enabled');
                if (pushCheckbox) {
                    pushCheckbox.addEventListener('change', async (e) => {
                        if (e.target.checked) {
                            console.log('[App] 🔔 Solicitando suscripción a notificaciones...');
                            if (window.oneSignalManager && window.oneSignalManager.isInitialized) {
                                try {
                                    await window.oneSignalManager.subscribe();
                                    const pushStatus = document.getElementById('push-status');
                                    if (pushStatus) {
                                        pushStatus.style.display = 'block';
                                        pushStatus.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Notificaciones habilitadas</span>';
                                    }
                                } catch (error) {
                                    console.error('[App] ❌ Error en suscripción:', error);
                                    e.target.checked = false;
                                    alert('Error activando notificaciones: ' + error.message);
                                }
                            } else {
                                console.warn('[App] ⚠️ OneSignal no inicializado');
                                e.target.checked = false;
                                alert('OneSignal no está inicializado. Por favor, recarga la página.');
                            }
                        } else {
                            // Desuscribir
                            if (window.oneSignalManager && window.oneSignalManager.isInitialized) {
                                try {
                                    await window.oneSignalManager.unsubscribe();
                                    const pushStatus = document.getElementById('push-status');
                                    if (pushStatus) {
                                        pushStatus.style.display = 'none';
                                    }
                                } catch (error) {
                                    console.error('[App] ❌ Error cancelando suscripción:', error);
                                }
                            }
                        }
                    });
                }

                // Mostrar tarjeta de debug si hay problemas
                setTimeout(() => {
                    if (!window.oneSignalManager || !window.oneSignalManager.isInitialized) {
                        console.warn('[App] ⚠️ OneSignal no inicializado después de 10 segundos, mostrando debug');
                        const debugCard = document.getElementById('debug-card');
                        if (debugCard) {
                            debugCard.style.display = 'block';
                        }
                    }
                }, 10000);
            });

            // Funciones de debug para OneSignal
            function debugOneSignal() {
                console.log('🔍 === DEBUG ONESIGNAL ===');
                
                if (window.oneSignalManager) {
                    console.log('✅ OneSignalManager disponible');
                    console.log('Inicializado:', window.oneSignalManager.isInitialized);
                    
                    if (window.OneSignal) {
                        console.log('✅ OneSignal SDK disponible');
                        
                        try {
                            const permission = OneSignal.Notifications.permission;
                            const optedIn = OneSignal.User.PushSubscription.optedIn;
                            const id = OneSignal.User.PushSubscription.id;
                            
                            console.log('Permiso:', permission);
                            console.log('Opted In:', optedIn);
                            console.log('ID:', id);
                            
                            alert(`OneSignal Debug:\nPermiso: ${permission}\nOpted In: ${optedIn}\nID: ${id || 'null'}`);
                        } catch (error) {
                            console.error('Error obteniendo estado:', error);
                            alert('Error obteniendo estado OneSignal: ' + error.message);
                        }
                    } else {
                        console.log('❌ OneSignal SDK no disponible');
                        alert('OneSignal SDK no está disponible');
                    }
                } else {
                    console.log('❌ OneSignalManager no disponible');
                    alert('OneSignalManager no está disponible');
                }
            }
            
            function forceInitOneSignal() {
                console.log('🔄 Forzando inicialización OneSignal...');
                
                if (window.oneSignalManager) {
                    window.oneSignalManager.initialize().then(() => {
                        console.log('✅ Inicialización forzada exitosa');
                        alert('OneSignal inicializado exitosamente');
                    }).catch(error => {
                        console.error('❌ Error en inicialización forzada:', error);
                        alert('Error en inicialización: ' + error.message);
                    });
                } else {
                    // Crear nuevo manager
                    const manager = new window.OneSignalManager();
                    window.oneSignalManager = manager;
                    
                    manager.initialize().then(() => {
                        console.log('✅ Manager creado e inicializado');
                        alert('OneSignal manager creado e inicializado');
                    }).catch(error => {
                        console.error('❌ Error creando manager:', error);
                        alert('Error creando manager: ' + error.message);
                    });
                }
            }
        </script>

        <!-- PWA Service Worker -->
        <script>
            // Variable para controlar actualizaciones
            let swUpdateAvailable = false;
            let swRegistration = null;
            
            // Versión actual de la aplicación (cambiar solo cuando queramos forzar actualización)
            const APP_VERSION = '1.2.0';
            
            // Registrar Service Worker para funcionalidad PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js', {
                        // Desactivar actualizaciones automáticas
                        updateViaCache: 'none'
                    })
                        .then(registration => {
                            swRegistration = registration;
                            console.log('✅ PWA Service Worker registrado:', registration.scope);

                            // Establecer versión inicial
                            localStorage.setItem('app_version', APP_VERSION);
                            console.log('� Versión establecida:', APP_VERSION);
                            
                        })
                        .catch(error => {
                            console.warn('⚠️ Error registrando PWA Service Worker:', error);
                        });
                }, 2000);

                // Escuchar cambios en el Service Worker
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('🔄 PWA Service Worker actualizado');
                });
            } else {
                console.warn('⚠️ Service Workers no soportados en este navegador');
            }
            
            // Función para verificar actualizaciones manualmente (para uso futuro)
            function checkForUpdates() {
                if (swRegistration) {
                    console.log('🔍 Verificando actualizaciones manualmente...');
                    swRegistration.update();
                }
            }
            
            // Función para forzar actualización (para desarrollo)
            function forceUpdate() {
                if (confirm('¿Forzar actualización de la aplicación?')) {
                    localStorage.removeItem('app_version');
                    window.location.reload(true);
                }
            }
        </script>
    </body>

</html>